<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Checklist Fardos</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --bg-color: #f5f5f7;
            --card-bg: #ffffff;
            --primary-color: #007aff;
            --success-color: #34c759;
            --warning-color: #ff9500;
            --danger-color: #ff3b30;
            --text-color: #1c1c1e;
            --light-text: #8e8e93;
            --border-color: #d1d1d6;
            --header-bg: #f2f2f7;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            padding: 0;
            overflow-x: hidden;
        }

        .iphone-container {
            max-width: 420px;
            margin: 0 auto;
            background: white;
            border-radius: 30px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            position: relative;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .status-bar {
            background: var(--header-bg);
            padding: 12px 20px 8px;
            text-align: center;
            font-size: 14px;
            color: var(--text-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-time {
            font-weight: 600;
        }

        .status-icons {
            display: flex;
            gap: 5px;
        }

        .header {
            background: var(--header-bg);
            padding: 15px 20px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
        }

        .header h1 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .header .subtitle {
            font-size: 14px;
            color: var(--light-text);
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0;
            background: white;
            border-bottom: 1px solid var(--border-color);
            padding: 15px 0;
        }

        .stat-card {
            text-align: center;
            padding: 10px;
            border-right: 1px solid var(--border-color);
        }

        .stat-card:last-child {
            border-right: none;
        }

        .stat-number {
            font-size: 20px;
            font-weight: 600;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 12px;
            color: var(--light-text);
            margin-top: 4px;
        }

        .m2-total {
            background: white;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .m2-label {
            font-size: 14px;
            color: var(--light-text);
        }

        .m2-value {
            font-size: 24px;
            font-weight: 600;
            color: var(--success-color);
        }

        .content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: var(--bg-color);
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
        }

        .card h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-color);
        }

        .scanner-input {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 15px;
            text-align: center;
        }

        .scanner-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .btn {
            display: block;
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 10px;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-secondary {
            background: var(--header-bg);
            color: var(--primary-color);
        }

        .btn:active {
            transform: scale(0.98);
        }

        .fardo-list {
            margin-top: 15px;
        }

        .fardo-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .fardo-checkbox {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .fardo-checkbox.checked {
            background: var(--success-color);
            border-color: var(--success-color);
            color: white;
        }

        .fardo-info {
            flex: 1;
        }

        .fardo-number {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .fardo-details {
            font-size: 14px;
            color: var(--light-text);
        }

        .fardo-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending {
            background: var(--header-bg);
            color: var(--warning-color);
        }

        .status-found {
            background: rgba(52, 199, 89, 0.2);
            color: var(--success-color);
        }

        .status-missing {
            background: rgba(255, 59, 48, 0.2);
            color: var(--danger-color);
        }

        .timestamp {
            font-size: 12px;
            color: var(--light-text);
            margin-top: 4px;
        }

        .progress-container {
            margin: 20px 0;
        }

        .progress-bar {
            height: 8px;
            background: var(--header-bg);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-color);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 14px;
            color: var(--light-text);
            text-align: center;
        }

        .file-upload {
            border: 2px dashed var(--border-color);
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            margin-bottom: 15px;
            transition: all 0.2s;
        }

        .file-upload:hover {
            border-color: var(--primary-color);
            background: rgba(0, 122, 255, 0.05);
        }

        .file-upload input {
            display: none;
        }

        .upload-icon {
            font-size: 32px;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 20px;
            border-radius: 20px;
            color: white;
            font-size: 14px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            animation: fadeIn 0.3s, fadeOut 0.3s 2.7s;
        }

        .notification.success {
            background: var(--success-color);
        }

        .notification.error {
            background: var(--danger-color);
        }

        .notification.warning {
            background: var(--warning-color);
            color: var(--text-color);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-50%) translateY(-20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        .empty-state {
            text-align: center;
            padding: 40px 0;
            color: var(--light-text);
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 15px;
            color: var(--border-color);
        }

        .search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .search-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 14px;
        }

        .filter-select {
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 14px;
            background: white;
        }

        .bottom-nav {
            background: white;
            border-top: 1px solid var(--border-color);
            padding: 10px 0;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0;
        }

        .nav-item {
            text-align: center;
            padding: 10px;
            cursor: pointer;
            color: var(--light-text);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .nav-item.active {
            color: var(--primary-color);
        }

        .nav-icon {
            font-size: 20px;
        }

        .nav-label {
            font-size: 10px;
            font-weight: 500;
        }

        .bluetooth-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(0, 122, 255, 0.1);
            border-radius: 20px;
            font-size: 12px;
            margin-bottom: 15px;
        }

        .bluetooth-icon {
            width: 12px;
            height: 12px;
            background: var(--primary-color);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .last-scanned {
            margin-top: 15px;
            padding: 12px;
            background: var(--header-bg);
            border-radius: 8px;
            font-size: 14px;
        }

        .last-scanned h4 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-color);
        }

        .last-scanned-details {
            font-size: 13px;
            color: var(--light-text);
        }
    </style>
</head>
<body>
    <div class="iphone-container">
        <div class="status-bar">
            <div class="status-time">9:41</div>
            <div class="status-icons">📶📶📶🔋🔄</div>
        </div>

        <div class="header">
            <h1>Checklist Fardos</h1>
            <div class="subtitle">GIBOR, S.A.</div>
        </div>

        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-number" id="totalFardos">0</div>
                <div class="stat-label">Total</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="fardosEncontrados">0</div>
                <div class="stat-label">Encontrados</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="fardosPendientes">0</div>
                <div class="stat-label">Pendientes</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="porcentajeCompleto">0%</div>
                <div class="stat-label">% Completo</div>
            </div>
        </div>

        <div class="m2-total">
            <div class="m2-label">M² Escaneados:</div>
            <div class="m2-value" id="m2Escaneados">0.00</div>
        </div>

        <div class="content">
            <div class="card">
                <h3>Escáner de Códigos</h3>
                <div class="bluetooth-status">
                    <div class="bluetooth-icon"></div>
                    <span>Escáner Bluetooth Conectado</span>
                </div>
                <input type="text" id="barcodeInput" class="scanner-input"
                       placeholder="Escanee o ingrese código de fardo..."
                       autocomplete="off">

                <div class="last-scanned" id="infoUltimoEscaneado" style="display: none;">
                    <h4>ÚLTIMO PAQUETE ESCANEADO:</h4>
                    <div class="last-scanned-details" id="detallesPaquete"></div>
                </div>
            </div>

            <div class="card">
                <h3>Búsqueda y Filtros</h3>
                <div class="search-container">
                    <input type="text" id="searchInput" class="search-input"
                           placeholder="Buscar fardo...">
                    <select id="filterStatus" class="filter-select">
                        <option value="all">Todos</option>
                        <option value="found">Encontrados</option>
                        <option value="pending">Pendientes</option>
                        <option value="missing">Faltantes</option>
                    </select>
                </div>
            </div>

            <div class="card">
                <h3>Acciones</h3>
                <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                    📁 Cargar Archivo Excel
                </button>
                <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;"
                       onchange="procesarArchivo(this.files[0])">

                <button class="btn btn-secondary" onclick="cargarEjemplo()">
                    📋 Cargar Ejemplo
                </button>

                <button class="btn btn-warning" onclick="marcarFaltantes()">
                    ⚠️ Marcar Faltantes
                </button>

                <button class="btn btn-danger" onclick="limpiarTodo()">
                    🗑️ Limpiar Todo
                </button>
            </div>

            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">
                    Cargar archivo Excel para comenzar
                </div>
            </div>

            <div class="card">
                <h3>Lista de Fardos</h3>
                <div class="fardo-list" id="checklistContainer">
                    <div class="empty-state">
                        <div class="empty-icon">📦</div>
                        <div>No hay fardos cargados</div>
                        <div style="font-size: 12px; color: var(--light-text); margin-top: 8px;">
                            Carga un archivo Excel o usa el ejemplo
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="bottom-nav">
            <div class="nav-item" onclick="exportarExcel()">
                <div class="nav-icon">📊</div>
                <div class="nav-label">Excel</div>
            </div>
            <div class="nav-item" onclick="exportarPDF()">
                <div class="nav-icon">📄</div>
                <div class="nav-label">PDF</div>
            </div>
            <div class="nav-item" onclick="exportarFaltantes()">
                <div class="nav-icon">⚠️</div>
                <div class="nav-label">Faltantes</div>
            </div>
            <div class="nav-item" onclick="exportarEscaneados()">
                <div class="nav-icon">📈</div>
                <div class="nav-label">Escaneados</div>
            </div>
        </div>
    </div>

    <script>
        let fardosData = [];
        let checklistData = new Map();
        let currentFilter = 'all';
        let currentSearch = '';
        let m2EscaneadosTotal = 0;
        let paquetesEscaneados = [];

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            cargarDatosGuardados();
        });

        function initializeEventListeners() {
            // Escáner de código de barras
            const barcodeInput = document.getElementById('barcodeInput');
            barcodeInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    procesarCodigoEscaneado(barcodeInput.value.trim());
                    barcodeInput.value = '';
                }
            });

            // Auto-submit después de escanear
            let scanTimeout;
            barcodeInput.addEventListener('input', (e) => {
                clearTimeout(scanTimeout);
                const codigo = e.target.value.trim();

                if (codigo.length >= 3) {
                    scanTimeout = setTimeout(() => {
                        procesarCodigoEscaneado(codigo);
                        barcodeInput.value = '';
                    }, 500);
                }
            });

            // Búsqueda y filtros
            document.getElementById('searchInput').addEventListener('input', (e) => {
                currentSearch = e.target.value.toLowerCase();
                renderizarLista();
            });

            document.getElementById('filterStatus').addEventListener('change', (e) => {
                currentFilter = e.target.value;
                renderizarLista();
            });
        }

        function procesarArchivo(file) {
            mostrarNotificacion('Procesando archivo...', 'warning');
            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets["Packing List"];

                    if (!sheet) {
                        throw new Error('La hoja "Packing List" no fue encontrada');
                    }

                    const excelData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                    extraerFardos(excelData);

                } catch (error) {
                    console.error('Error procesando archivo:', error);
                    mostrarNotificacion('Error al procesar el archivo: ' + error.message, 'error');
                }
            };

            reader.readAsArrayBuffer(file);
        }

        function extraerFardos(excelData) {
            fardosData = [];
            const textoC6 = excelData[5]?.[2] || 'Información no disponible';
            const textoA7 = excelData[6]?.[0] || 'Información no disponible';
            let paqueteActual = '';
            let fardoActual = null;

            for (let i = 12; i < excelData.length; i++) {
                const fila = excelData[i];
                if (!fila || !fila[1]) continue;

                const paquete = fila[1].toString().trim();
                const m2 = parseFloat(fila[7]) || 0;
                const piezasRaw = (fila[4] || '').toString().split('\n').filter(p => p && p.trim());
                const largosRaw = (fila[5] || '').toString().split('\n').filter(l => l && l.trim());

                if (paquete !== paqueteActual) {
                    paqueteActual = paquete;
                    fardoActual = {
                        id: paquete,
                        numero: paquete,
                        m2: 0,
                        piezas: [],
                        largos: [],
                        textoC6,
                        textoA7,
                        encontrado: false,
                        timestamp: null,
                        estado: 'pending',
                        totalPiezas: 0
                    };
                    fardosData.push(fardoActual);
                }

                if (fardoActual) {
                    fardoActual.m2 += m2;
                    fardoActual.piezas.push(...piezasRaw);
                    fardoActual.largos.push(...largosRaw);
                    fardoActual.totalPiezas = Math.max(fardoActual.piezas.length, fardoActual.largos.length);
                }
            }

            inicializarChecklist();
            mostrarNotificacion(`✅ ${fardosData.length} fardos cargados correctamente`, 'success');
        }

        function inicializarChecklist() {
            checklistData.clear();
            m2EscaneadosTotal = 0;
            paquetesEscaneados = [];
            document.getElementById('m2Escaneados').textContent = '0.00';

            // Crear nuevos objetos para evitar referencias
            fardosData.forEach(fardo => {
                checklistData.set(fardo.id, {
                    id: fardo.id,
                    numero: fardo.numero,
                    m2: fardo.m2,
                    piezas: [...fardo.piezas],
                    largos: [...fardo.largos],
                    textoC6: fardo.textoC6,
                    textoA7: fardo.textoA7,
                    encontrado: false,
                    timestamp: null,
                    estado: 'pending',
                    totalPiezas: fardo.totalPiezas
                });
            });

            actualizarEstadisticas();
            renderizarLista();
            guardarDatos();
        }

        function procesarCodigoEscaneado(codigo) {
            if (!codigo) return;

            if (!checklistData.has(codigo)) {
                mostrarNotificacion(`❌ Fardo ${codigo} no encontrado en la lista`, 'error');
                document.getElementById('infoUltimoEscaneado').style.display = 'none';
                return;
            }

            const fardo = checklistData.get(codigo);

            if (fardo.encontrado) {
                mostrarNotificacion(`ℹ️ Fardo ${codigo} ya había sido encontrado`, 'warning');
                mostrarInfoPaquete(fardo);
                return;
            }

            // Marcar como encontrado
            fardo.encontrado = true;
            fardo.timestamp = new Date();
            fardo.estado = 'found';

            // Añadir al registro de paquetes escaneados
            paquetesEscaneados.push({
                id: fardo.id,
                numero: fardo.numero,
                m2: fardo.m2,
                piezas: [...fardo.piezas],
                largos: [...fardo.largos],
                timestamp: fardo.timestamp.toISOString(),
                totalPiezas: fardo.totalPiezas
            });

            // Sumar los m² escaneados
            m2EscaneadosTotal += fardo.m2;
            document.getElementById('m2Escaneados').textContent = m2EscaneadosTotal.toFixed(2);

            mostrarNotificacion(`✅ Fardo ${codigo} encontrado`, 'success');
            mostrarInfoPaquete(fardo);
            actualizarEstadisticas();
            renderizarLista();
            guardarDatos();
        }

        function mostrarInfoPaquete(fardo) {
            const infoContainer = document.getElementById('infoUltimoEscaneado');
            const detallesContainer = document.getElementById('detallesPaquete');

            detallesContainer.innerHTML = `
                <div><strong>Número:</strong> ${fardo.numero}</div>
                <div><strong>M²:</strong> ${fardo.m2.toFixed(2)}</div>
                <div><strong>Estado:</strong> ${fardo.encontrado ? 'Encontrado' : 'Pendiente'}</div>
                ${fardo.timestamp ? `<div><strong>Escaneado:</strong> ${fardo.timestamp.toLocaleString('es-GT')}</div>` : ''}
            `;

            infoContainer.style.display = 'block';
        }

        function renderizarLista() {
            const container = document.getElementById('checklistContainer');

            if (fardosData.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">📦</div>
                        <div>No hay fardos cargados</div>
                        <div style="font-size: 12px; color: var(--light-text); margin-top: 8px;">
                            Carga un archivo Excel o usa el ejemplo
                        </div>
                    </div>
                `;
                return;
            }

            let fardosFiltrados = Array.from(checklistData.values());

            // Aplicar filtro de estado
            if (currentFilter !== 'all') {
                fardosFiltrados = fardosFiltrados.filter(fardo => {
                    switch (currentFilter) {
                        case 'found': return fardo.encontrado;
                        case 'pending': return !fardo.encontrado && fardo.estado !== 'missing';
                        case 'missing': return fardo.estado === 'missing';
                        default: return true;
                    }
                });
            }

            // Aplicar filtro de búsqueda
            if (currentSearch) {
                fardosFiltrados = fardosFiltrados.filter(fardo =>
                    fardo.numero.toLowerCase().includes(currentSearch) ||
                    fardo.id.toLowerCase().includes(currentSearch)
                );
            }

            // Ordenar: encontrados al final, pendientes primero
            fardosFiltrados.sort((a, b) => {
                if (a.encontrado && !b.encontrado) return 1;
                if (!a.encontrado && b.encontrado) return -1;
                return a.numero.localeCompare(b.numero);
            });

            const html = fardosFiltrados.map(fardo => {
                const statusClass = fardo.encontrado ? 'found' :
                                  fardo.estado === 'missing' ? 'missing' : 'pending';
                const statusText = fardo.encontrado ? 'Encontrado' :
                                 fardo.estado === 'missing' ? 'Faltante' : 'Pendiente';
                const timestampText = fardo.timestamp ?
                    `Escaneado: ${fardo.timestamp.toLocaleString('es-GT')}` : '';

                return `
                    <div class="fardo-item" data-fardo="${fardo.id}">
                        <div class="fardo-checkbox ${fardo.encontrado ? 'checked' : ''}"
                             onclick="toggleFardo('${fardo.id}')">
                            ${fardo.encontrado ? '✓' : ''}
                        </div>
                        <div class="fardo-info">
                            <div class="fardo-number">Fardo No. ${fardo.numero}</div>
                            <div class="fardo-details">${fardo.m2.toFixed(2)} M² • ${fardo.totalPiezas} piezas</div>
                            <div class="timestamp">${timestampText}</div>
                        </div>
                        <div class="fardo-status status-${statusClass}">
                            ${statusText}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        function toggleFardo(id) {
            if (!checklistData.has(id)) return;

            const fardo = checklistData.get(id);

            if (fardo.encontrado) {
                // Desmarcar fardo
                fardo.encontrado = false;
                fardo.timestamp = null;
                fardo.estado = 'pending';

                // Restar los m² escaneados
                m2EscaneadosTotal -= fardo.m2;
                document.getElementById('m2Escaneados').textContent = m2EscaneadosTotal.toFixed(2);

                // Remover del registro de paquetes escaneados
                paquetesEscaneados = paquetesEscaneados.filter(p => p.id !== id);

                mostrarNotificacion(`ℹ️ Fardo ${id} desmarcado`, 'warning');
            } else {
                // Marcar fardo como encontrado
                fardo.encontrado = true;
                fardo.timestamp = new Date();
                fardo.estado = 'found';

                // Añadir al registro de paquetes escaneados
                paquetesEscaneados.push({
                    id: fardo.id,
                    numero: fardo.numero,
                    m2: fardo.m2,
                    piezas: [...fardo.piezas],
                    largos: [...fardo.largos],
                    timestamp: fardo.timestamp.toISOString(),
                    totalPiezas: fardo.totalPiezas
                });

                // Sumar los m² escaneados
                m2EscaneadosTotal += fardo.m2;
                document.getElementById('m2Escaneados').textContent = m2EscaneadosTotal.toFixed(2);

                mostrarNotificacion(`✅ Fardo ${id} marcado como encontrado`, 'success');
            }

            actualizarEstadisticas();
            renderizarLista();
            guardarDatos();
        }

        function actualizarEstadisticas() {
            const total = checklistData.size;
            const encontrados = Array.from(checklistData.values()).filter(f => f.encontrado).length;
            const pendientes = Array.from(checklistData.values()).filter(f => !f.encontrado && f.estado !== 'missing').length;
            const faltantes = Array.from(checklistData.values()).filter(f => f.estado === 'missing').length;
            const porcentaje = total > 0 ? Math.round((encontrados / total) * 100) : 0;

            document.getElementById('totalFardos').textContent = total;
            document.getElementById('fardosEncontrados').textContent = encontrados;
            document.getElementById('fardosPendientes').textContent = pendientes + faltantes;
            document.getElementById('porcentajeCompleto').textContent = `${porcentaje}%`;

            // Actualizar barra de progreso
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');

            progressFill.style.width = `${porcentaje}%`;

            if (total === 0) {
                progressText.textContent = 'Cargar archivo Excel para comenzar';
            } else if (porcentaje === 100) {
                progressText.textContent = '🎉 ¡Todos los fardos han sido encontrados!';
            } else {
                progressText.textContent = `${encontrados} de ${total} fardos completados`;
            }
        }

        function cargarEjemplo() {
            fardosData = [
                {
                    id: 'F001',
                    numero: 'F001',
                    m2: 15.50,
                    piezas: ['1', '2', '3', '4'],
                    largos: ['2.40', '2.40', '2.20', '2.20'],
                    textoC6: 'Madera de Pino - Ejemplo',
                    textoA7: 'Exportación Guatemala',
                    encontrado: false,
                    timestamp: null,
                    estado: 'pending',
                    totalPiezas: 4
                },
                {
                    id: 'F002',
                    numero: 'F002',
                    m2: 18.75,
                    piezas: ['1', '2', '3', '4', '5'],
                    largos: ['2.40', '2.40', '2.40', '2.20', '2.20'],
                    textoC6: 'Madera de Pino - Ejemplo',
                    textoA7: 'Exportación Guatemala',
                    encontrado: false,
                    timestamp: null,
                    estado: 'pending',
                    totalPiezas: 5
                },
                {
                    id: 'F003',
                    numero: 'F003',
                    m2: 12.30,
                    piezas: ['1', '2', '3'],
                    largos: ['2.40', '2.20', '2.20'],
                    textoC6: 'Madera de Pino - Ejemplo',
                    textoA7: 'Exportación Guatemala',
                    encontrado: false,
                    timestamp: null,
                    estado: 'pending',
                    totalPiezas: 3
                }
            ];

            paquetesEscaneados = [];
            m2EscaneadosTotal = 0;
            document.getElementById('m2Escaneados').textContent = '0.00';

            inicializarChecklist();
            mostrarNotificacion('✅ Datos de ejemplo cargados correctamente', 'success');
        }

        function limpiarTodo() {
            if (confirm('¿Estás seguro de que quieres limpiar todos los datos?')) {
                fardosData = [];
                checklistData.clear();
                paquetesEscaneados = [];
                m2EscaneadosTotal = 0;
                document.getElementById('m2Escaneados').textContent = '0.00';
                currentFilter = 'all';
                currentSearch = '';

                document.getElementById('searchInput').value = '';
                document.getElementById('filterStatus').value = 'all';
                document.getElementById('infoUltimoEscaneado').style.display = 'none';

                actualizarEstadisticas();
                renderizarLista();
                limpiarDatosGuardados();
                mostrarNotificacion('🗑️ Todos los datos han sido limpiados', 'warning');
            }
        }

        function marcarFaltantes() {
            if (confirm('¿Marcar todos los fardos pendientes como faltantes?')) {
                let marcados = 0;
                checklistData.forEach(fardo => {
                    if (!fardo.encontrado && fardo.estado !== 'missing') {
                        fardo.estado = 'missing';
                        marcados++;
                    }
                });

                if (marcados > 0) {
                    mostrarNotificacion(`⚠️ ${marcados} fardos marcados como faltantes`, 'warning');
                    renderizarLista();
                    guardarDatos();
                } else {
                    mostrarNotificacion('No hay fardos pendientes para marcar', 'warning');
                }
            }
        }

        function exportarExcel() {
            if (checklistData.size === 0) {
                mostrarNotificacion('No hay datos para exportar', 'warning');
                return;
            }

            const datos = Array.from(checklistData.values()).map(fardo => ({
                'NÚMERO DE FARDO': fardo.numero,
                'M² TOTAL': fardo.m2.toFixed(2),
                'TOTAL PIEZAS': fardo.totalPiezas,
                'ESTADO': fardo.encontrado ? 'ENCONTRADO' : (fardo.estado === 'missing' ? 'FALTANTE' : 'PENDIENTE'),
                'FECHA ENCONTRADO': fardo.timestamp ? fardo.timestamp.toLocaleString('es-GT') : 'NO ESCANEADO',
                'PIEZAS': fardo.piezas.join(', '),
                'LARGOS': fardo.largos.join(', ')
            }));

            const worksheet = XLSX.utils.json_to_sheet(datos);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'CHECKLIST FARDOS');
            const fecha = new Date().toISOString().split('T')[0];
            XLSX.writeFile(workbook, `CHECKLIST_FARDOS_${fecha}.xlsx`);

            mostrarNotificacion('📊 Archivo Excel exportado correctamente', 'success');
        }

        function exportarPDF() {
            if (checklistData.size === 0) {
                mostrarNotificacion('No hay datos para exportar', 'warning');
                return;
            }

            mostrarNotificacion('📄 Función de exportar PDF en desarrollo', 'warning');
        }

        function exportarFaltantes() {
            const faltantes = Array.from(checklistData.values()).filter(f => !f.encontrado);

            if (faltantes.length === 0) {
                mostrarNotificacion('No hay fardos faltantes para exportar', 'warning');
                return;
            }

            const datos = faltantes.map(fardo => ({
                'NÚMERO DE FARDO': fardo.numero,
                'M² TOTAL': fardo.m2.toFixed(2),
                'TOTAL PIEZAS': fardo.totalPiezas,
                'ESTADO': fardo.estado === 'missing' ? 'FALTANTE' : 'PENDIENTE',
                'PIEZAS': fardo.piezas.join(', '),
                'LARGOS': fardo.largos.join(', ')
            }));

            const worksheet = XLSX.utils.json_to_sheet(datos);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'FARDOS FALTANTES');
            const fecha = new Date().toISOString().split('T')[0];
            XLSX.writeFile(workbook, `FARDOS_FALTANTES_${fecha}.xlsx`);

            mostrarNotificacion(`⚠️ ${faltantes.length} fardos faltantes exportados`, 'success');
        }

        function exportarEscaneados() {
            if (paquetesEscaneados.length === 0) {
                mostrarNotificacion('No hay paquetes escaneados para exportar', 'warning');
                return;
            }

            const datos = paquetesEscaneados.map(fardo => ({
                'NÚMERO DE FARDO': fardo.numero,
                'M²': fardo.m2.toFixed(2),
                'TOTAL PIEZAS': fardo.totalPiezas,
                'FECHA ENCONTRADO': new Date(fardo.timestamp).toLocaleString('es-GT'),
                'PIEZAS': fardo.piezas.join(', '),
                'LARGOS': fardo.largos.join(', ')
            }));

            // Añadir fila con el total de m²
            datos.push({
                'NÚMERO DE FARDO': 'TOTAL ESCANEADO',
                'M²': m2EscaneadosTotal.toFixed(2),
                'TOTAL PIEZAS': paquetesEscaneados.reduce((sum, fardo) => sum + fardo.totalPiezas, 0),
                'FECHA ENCONTRADO': '',
                'PIEZAS': '',
                'LARGOS': ''
            });

            const worksheet = XLSX.utils.json_to_sheet(datos);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'PAQUETES ESCANEADOS');
            const fecha = new Date().toISOString().split('T')[0];
            XLSX.writeFile(workbook, `PAQUETES_ESCANEADOS_${fecha}.xlsx`);

            mostrarNotificacion(`📊 ${paquetesEscaneados.length} paquetes escaneados exportados`, 'success');
        }

        function mostrarNotificacion(mensaje, tipo = 'success') {
            // Remover notificaciones anteriores
            document.querySelectorAll('.notification').forEach(n => n.remove());

            const notification = document.createElement('div');
            notification.className = `notification ${tipo}`;
            notification.textContent = mensaje;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function guardarDatos() {
            try {
                const datos = {
                    fardosData: fardosData,
                    checklistData: Array.from(checklistData.entries()).map(([id, fardo]) => [
                        id,
                        {
                            id: fardo.id,
                            numero: fardo.numero,
                            m2: fardo.m2,
                            piezas: fardo.piezas,
                            largos: fardo.largos,
                            textoC6: fardo.textoC6,
                            textoA7: fardo.textoA7,
                            encontrado: fardo.encontrado,
                            timestamp: fardo.timestamp ? fardo.timestamp.toISOString() : null,
                            estado: fardo.estado,
                            totalPiezas: fardo.totalPiezas
                        }
                    ]),
                    paquetesEscaneados: paquetesEscaneados,
                    m2EscaneadosTotal: m2EscaneadosTotal,
                    timestamp: new Date().toISOString()
                };

                localStorage.setItem('checklistFardosData', JSON.stringify(datos));
            } catch (error) {
                console.error('Error al guardar datos:', error);
            }
        }

        function cargarDatosGuardados() {
            try {
                const datos = localStorage.getItem('checklistFardosData');
                if (datos) {
                    const parsed = JSON.parse(datos);

                    fardosData = parsed.fardosData || [];
                    checklistData = new Map();

                    parsed.checklistData.forEach(([id, fardo]) => {
                        checklistData.set(id, {
                            ...fardo,
                            timestamp: fardo.timestamp ? new Date(fardo.timestamp) : null
                        });
                    });

                    paquetesEscaneados = parsed.paquetesEscaneados || [];
                    m2EscaneadosTotal = parsed.m2EscaneadosTotal || 0;
                    document.getElementById('m2Escaneados').textContent = m2EscaneadosTotal.toFixed(2);

                    actualizarEstadisticas();
                    renderizarLista();
                }
            } catch (error) {
                console.error('Error al cargar datos:', error);
                mostrarNotificacion('Error al cargar datos guardados', 'error');
            }
        }

        function limpiarDatosGuardados() {
            try {
                localStorage.removeItem('checklistFardosData');
            } catch (error) {
                console.error('Error al limpiar datos:', error);
            }
        }

        // Enfocar el campo de escáner al cargar la página
        window.addEventListener('load', () => {
            setTimeout(() => {
                document.getElementById('barcodeInput').focus();
            }, 500);
        });
    </script>
</body>
</html>
